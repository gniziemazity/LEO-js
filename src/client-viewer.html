<!doctype html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>LEO Client</title>
      <link rel="icon" href="icon.ico" type="image/x-icon" />
      <link rel="stylesheet" href="styles.css" />
      <style>
         /* MOBILE UI OVERRIDES */
         body {
            padding-top: 0;
            background: #f5f5f5;
         }

         #mobile-header {
            position: sticky;
            top: 0;
            background: #2c3e50;
            color: white;
            z-index: 2000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            width: 100%;
         }

         .header-main-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
         }

         #lessonName {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ecf0f1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 65%;
         }

         #toggleBtn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
         }

         #timerDisplay {
            font-size: 1.4rem !important;
            color: #ecf0f1 !important;
            font-family: "Consolas", monospace;
            margin: 0 !important;
            text-align: right !important;
         }

         .block.active-comment,
         .char.cursor {
            scroll-margin-top: 80px;
         }
      </style>
   </head>
   <body>
      <div id="mobile-header">
         <div class="header-main-row">
            <button id="toggleBtn" onclick="toggleActive()">START</button>
            <div id="lessonName">Not Connected</div>
            <div id="timerDisplay">--:--:--</div>
         </div>
         <div class="progress-bar" id="progressBar"></div>
      </div>

      <div id="lesson-container">
         <div class="empty-state">Connecting to LEO...</div>
      </div>

      <script>
         let ws = null;
         let currentSettings = null;
         let isActive = false;

         const elements = {
            lessonName: document.getElementById("lessonName"),
            timerDisplay: document.getElementById("timerDisplay"),
            progressBar: document.getElementById("progressBar"),
            lessonContainer: document.getElementById("lesson-container"),
            toggleBtn: document.getElementById("toggleBtn"),
         };

         function connect() {
            const host = window.location.host;
            const protocol =
               window.location.protocol === "https:" ? "wss:" : "ws:";
            const wsUrl = `${protocol}//${host}`;

            console.log("Connecting to:", wsUrl);

            if (ws) ws.close();
            ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
               const message = JSON.parse(event.data);
               handleMessage(message);
            };

            ws.onclose = () => {
               ws = null;
               setTimeout(connect, 2000); // auto-reconnect
            };
         }

         function handleMessage(message) {
            const { type, data } = message;
            switch (type) {
               case "state":
                  updateAllState(data);
                  break;
               case "lesson-data":
                  updateLessonData(data);
                  break;
               case "cursor":
                  updateCursor(data);
                  break;
               case "progress":
                  updateProgress(data);
                  break;
               case "timer":
                  updateTimer(data.timeRemaining);
                  break;
               case "lesson":
                  updateLessonName(data.lessonName);
                  break;
               case "settings":
                  applySettings(data);
                  break;
               case "active":
                  updateActiveState(data.isActive);
                  break;
            }
         }

         function updateAllState(state) {
            updateProgress(state);
            updateTimer(state.timeRemaining);
            updateLessonName(state.lessonName);
            if (state.isActive !== undefined) {
               updateActiveState(state.isActive);
            }
            if (state.settings) {
               applySettings(state.settings);
            }
            if (state.lessonData) {
               updateLessonData(state.lessonData);
            }
            if (state.currentStep !== undefined) {
               updateCursor({ currentStep: state.currentStep });
            }
         }

         function updateActiveState(active) {
            isActive = active;
            if (active) {
               elements.toggleBtn.textContent = "STOP";
               elements.toggleBtn.style.background = "#e74c3c";
            } else {
               elements.toggleBtn.textContent = "START";
               elements.toggleBtn.style.background = "#27ae60";
            }
         }

         function applySettings(settings) {
            currentSettings = settings;

            const styleId = "dynamic-settings-styles";
            let styleEl = document.getElementById(styleId);

            if (!styleEl) {
               styleEl = document.createElement("style");
               styleEl.id = styleId;
               document.head.appendChild(styleEl);
            }

            styleEl.textContent = `
               body {
                  font-size: ${settings.fontSize}px;
               }
               
               .comment-block,
               .code-block {
                  color: ${settings.colors.textColor};
               }
               
               .comment-block {
                  background: ${settings.colors.commentNormal};
               }
               
               .comment-block.active-comment {
                  background: ${settings.colors.commentActive};
                  color: ${settings.colors.commentActiveText};
               }
               
               .char.cursor {
                  background: ${settings.colors.cursor};
               }
            `;
         }

         function updateLessonData(data) {
            const { blocks } = data;
            elements.lessonContainer.innerHTML = "";
            if (!blocks || blocks.length === 0) {
               return;
            }

            let globalStepCounter = 0;
            blocks.forEach((block) => {
               const blockDiv = document.createElement("div");
               blockDiv.className = `block ${block.type}-block`;

               if (block.type === "comment") {
                  blockDiv.innerText = block.text;
                  blockDiv.dataset.stepIndex = globalStepCounter++;

                  blockDiv.onclick = handleBlockClick;
               } else if (block.type === "code") {
                  for (const char of block.text) {
                     let el = document.createElement("span");
                     el.className = "char";
                     if (char === "\n") el = document.createElement("br");
                     else if (char === " ") el.innerHTML = "&nbsp;";
                     else el.textContent = char;

                     el.dataset.stepIndex = globalStepCounter++;
                     blockDiv.appendChild(el);
                  }

                  blockDiv.onclick = handleCodeClick;
               }
               elements.lessonContainer.appendChild(blockDiv);
            });
         }

         function updateCursor(data) {
            const { currentStep } = data;
            document
               .querySelectorAll(".cursor, .consumed, .active-comment")
               .forEach((el) => {
                  el.classList.remove("cursor", "consumed", "active-comment");
               });

            const allSteps = document.querySelectorAll("[data-step-index]");
            allSteps.forEach((el) => {
               const stepIndex = parseInt(el.dataset.stepIndex);
               if (stepIndex < currentStep) {
                  el.classList.add("consumed");
               } else if (stepIndex === currentStep) {
                  const isChar = el.classList.contains("char");
                  el.classList.add(isChar ? "cursor" : "active-comment");
                  el.scrollIntoView({ behavior: "smooth", block: "center" });
               }
            });
         }

         function updateProgress(data) {
            if (data.progress !== undefined) {
               elements.progressBar.style.width = `${data.progress}%`;
            }
         }

         function updateTimer(timeRemaining) {
            elements.timerDisplay.textContent = timeRemaining || "--:--:--";
         }

         function updateLessonName(lessonName) {
            document.title = lessonName ? `LEO - ${lessonName}` : "LEO";
            elements.lessonName.textContent = lessonName;
         }

         function sendMessage(type, data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
               ws.send(JSON.stringify({ type, data }));
            }
         }

         function handleCodeClick(e) {
            if (!isActive) return;
            const clickedSpan = e.target.closest(".char");
            if (clickedSpan) {
               const stepIndex = parseInt(clickedSpan.dataset.stepIndex);
               sendMessage("jump-to", { stepIndex });
            }
         }

         function handleBlockClick(e) {
            if (!isActive) return;
            const blockDiv = e.target.closest(".block");
            if (blockDiv && blockDiv.dataset.stepIndex) {
               const stepIndex = parseInt(blockDiv.dataset.stepIndex);
               sendMessage("jump-to", { stepIndex });
            }
         }

         function toggleActive() {
            sendMessage("toggle-active", {});
         }

         setTimeout(connect, 500);
      </script>
   </body>
</html>
